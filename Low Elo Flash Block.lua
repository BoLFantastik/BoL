local sversion = "0.1"
local AUTOUPDATE = true
local UPDATE_HOST = "raw.github.com"
local UPDATE_PATH = "/BoLFantastik/BoL/master/Low Elo Flash Block.lua".."?rand="..math.random(1,10000)
local UPDATE_FILE_PATH = SCRIPT_PATH..GetCurrentEnv().FILE_NAME
local UPDATE_URL = "https://"..UPDATE_HOST..UPDATE_PATH

function AutoupdaterMsg(msg) print("<font color = \"#FFFFFF\">[Low Elo Flash Block] </font><font color=\"#FF0000\">"..msg.."</font>") end
if AUTOUPDATE then
	local ServerData = GetWebResult(UPDATE_HOST, "/BoLFantastik/BoL/master/version/Low Elo Flash Block.version")
	if ServerData then
		ServerVersion = type(tonumber(ServerData)) == "number" and tonumber(ServerData) or nil
		if ServerVersion then
			if tonumber(sversion) < ServerVersion then
				AutoupdaterMsg("New version available"..ServerVersion)
				AutoupdaterMsg("Updating, please don't press F9")
				DelayAction(function() DownloadFile(UPDATE_URL, UPDATE_FILE_PATH, function () AutoupdaterMsg("Successfully updated. ("..sversion.." => "..ServerVersion.."), press F9 twice to load the updated version.") end) end, 3)
			else
				AutoupdaterMsg("You have got the latest version ("..ServerVersion..")")
			end
		end
	else
		AutoupdaterMsg("Error downloading version info")
	end
end

local bxor, lshift, band = bit32.bxor, bit32.lshift, bit32.band
local startBytes = {
	[0x9F] = 0x00, [0x8F] = 0x01, [0x97] = 0x02, [0x87] = 0x03, [0x9B] = 0x04, [0x8B] = 0x05, [0x93] = 0x06, [0x83] = 0x07, [0x9D] = 0x08, [0x8D] = 0x09, [0x95] = 0x0A, [0x85] = 0x0B, 
	[0x99] = 0x0C, [0x89] = 0x0D, [0x91] = 0x0E, [0x81] = 0x0F, [0x9E] = 0x10, [0x8E] = 0x11, [0x96] = 0x12, [0x86] = 0x13, [0x9A] = 0x14, [0x8A] = 0x15, [0x92] = 0x16, [0x82] = 0x17, 
	[0x9C] = 0x18, [0x8C] = 0x19, [0x94] = 0x1A, [0x84] = 0x1B, [0x98] = 0x1C, [0x88] = 0x1D, [0x90] = 0x1E, [0x80] = 0x1F, [0x1F] = 0x20, [0x0F] = 0x21, [0x17] = 0x22, [0x07] = 0x23, 
	[0x1B] = 0x24, [0x0B] = 0x25, [0x13] = 0x26, [0x03] = 0x27, [0x1D] = 0x28, [0x0D] = 0x29, [0x15] = 0x2A, [0x05] = 0x2B, [0x19] = 0x2C, [0x09] = 0x2D, [0x11] = 0x2E, [0x01] = 0x2F, 
	[0x1E] = 0x30, [0x0E] = 0x31, [0x16] = 0x32, [0x06] = 0x33, [0x1A] = 0x34, [0x0A] = 0x35, [0x12] = 0x36, [0x02] = 0x37, [0x1C] = 0x38, [0x0C] = 0x39, [0x14] = 0x3A, [0x04] = 0x3B, 
	[0x18] = 0x3C, [0x08] = 0x3D, [0x10] = 0x3E, [0x00] = 0x3F, [0xEF] = 0x40, [0xF7] = 0x41, [0xE7] = 0x42, [0xFB] = 0x43, [0xEB] = 0x44, [0xF3] = 0x45, [0xE3] = 0x46, [0xFD] = 0x47, 
	[0xED] = 0x48, [0xF5] = 0x49, [0xE5] = 0x4A, [0xF9] = 0x4B, [0xE9] = 0x4C, [0xF1] = 0x4D, [0xE1] = 0x4E, [0xFE] = 0x4F, [0xEE] = 0x50, [0xF6] = 0x51, [0xE6] = 0x52, [0xFA] = 0x53, 
	[0xEA] = 0x54, [0xF2] = 0x55, [0xE2] = 0x56, [0xFC] = 0x57, [0xEC] = 0x58, [0xF4] = 0x59, [0xE4] = 0x5A, [0xF8] = 0x5B, [0xE8] = 0x5C, [0xF0] = 0x5D, [0xE0] = 0x5E, [0x7F] = 0x5F, 
	[0x6F] = 0x60, [0x77] = 0x61, [0x67] = 0x62, [0x7B] = 0x63, [0x6B] = 0x64, [0x73] = 0x65, [0x63] = 0x66, [0x7D] = 0x67, [0x6D] = 0x68, [0x75] = 0x69, [0x65] = 0x6A, [0x79] = 0x6B, 
	[0x69] = 0x6C, [0x71] = 0x6D, [0x61] = 0x6E, [0x7E] = 0x6F, [0x6E] = 0x70, [0x76] = 0x71, [0x66] = 0x72, [0x7A] = 0x73, [0x6A] = 0x74, [0x72] = 0x75, [0x62] = 0x76, [0x7C] = 0x77, 
	[0x6C] = 0x78, [0x74] = 0x79, [0x64] = 0x7A, [0x78] = 0x7B, [0x68] = 0x7C, [0x70] = 0x7D, [0x60] = 0x7E, [0xFF] = 0x7F, [0xAF] = 0x80, [0xB7] = 0x81, [0xA7] = 0x82, [0xBB] = 0x83, 
	[0xAB] = 0x84, [0xB3] = 0x85, [0xA3] = 0x86, [0xBD] = 0x87, [0xAD] = 0x88, [0xB5] = 0x89, [0xA5] = 0x8A, [0xB9] = 0x8B, [0xA9] = 0x8C, [0xB1] = 0x8D, [0xA1] = 0x8E, [0xBE] = 0x8F, 
	[0xAE] = 0x90, [0xB6] = 0x91, [0xA6] = 0x92, [0xBA] = 0x93, [0xAA] = 0x94, [0xB2] = 0x95, [0xA2] = 0x96, [0xBC] = 0x97, [0xAC] = 0x98, [0xB4] = 0x99, [0xA4] = 0x9A, [0xB8] = 0x9B, 
	[0xA8] = 0x9C, [0xB0] = 0x9D, [0xA0] = 0x9E, [0x3F] = 0x9F, [0x2F] = 0xA0, [0x37] = 0xA1, [0x27] = 0xA2, [0x3B] = 0xA3, [0x2B] = 0xA4, [0x33] = 0xA5, [0x23] = 0xA6, [0x3D] = 0xA7, 
	[0x2D] = 0xA8, [0x35] = 0xA9, [0x25] = 0xAA, [0x39] = 0xAB, [0x29] = 0xAC, [0x31] = 0xAD, [0x21] = 0xAE, [0x3E] = 0xAF, [0x2E] = 0xB0, [0x36] = 0xB1, [0x26] = 0xB2, [0x3A] = 0xB3, 
	[0x2A] = 0xB4, [0x32] = 0xB5, [0x22] = 0xB6, [0x3C] = 0xB7, [0x2C] = 0xB8, [0x34] = 0xB9, [0x24] = 0xBA, [0x38] = 0xBB, [0x28] = 0xBC, [0x30] = 0xBD, [0x20] = 0xBE, [0xBF] = 0xBF, 
	[0xCF] = 0xC0, [0xD7] = 0xC1, [0xC7] = 0xC2, [0xDB] = 0xC3, [0xCB] = 0xC4, [0xD3] = 0xC5, [0xC3] = 0xC6, [0xDD] = 0xC7, [0xCD] = 0xC8, [0xD5] = 0xC9, [0xC5] = 0xCA, [0xD9] = 0xCB, 
	[0xC9] = 0xCC, [0xD1] = 0xCD, [0xC1] = 0xCE, [0xDE] = 0xCF, [0xCE] = 0xD0, [0xD6] = 0xD1, [0xC6] = 0xD2, [0xDA] = 0xD3, [0xCA] = 0xD4, [0xD2] = 0xD5, [0xC2] = 0xD6, [0xDC] = 0xD7, 
	[0xCC] = 0xD8, [0xD4] = 0xD9, [0xC4] = 0xDA, [0xD8] = 0xDB, [0xC8] = 0xDC, [0xD0] = 0xDD, [0xC0] = 0xDE, [0x5F] = 0xDF, [0x4F] = 0xE0, [0x57] = 0xE1, [0x47] = 0xE2, [0x5B] = 0xE3, 
	[0x4B] = 0xE4, [0x53] = 0xE5, [0x43] = 0xE6, [0x5D] = 0xE7, [0x4D] = 0xE8, [0x55] = 0xE9, [0x45] = 0xEA, [0x59] = 0xEB, [0x49] = 0xEC, [0x51] = 0xED, [0x41] = 0xEE, [0x5E] = 0xEF, 
	[0x4E] = 0xF0, [0x56] = 0xF1, [0x46] = 0xF2, [0x5A] = 0xF3, [0x4A] = 0xF4, [0x52] = 0xF5, [0x42] = 0xF6, [0x5C] = 0xF7, [0x4C] = 0xF8, [0x54] = 0xF9, [0x44] = 0xFA, [0x58] = 0xFB, 
	[0x48] = 0xFC, [0x50] = 0xFD, [0x40] = 0xFE, [0xDF] = 0xFF, 
}

local HaveIgnite = false

local flashslot = nil

local Igniter = nil
local Caster = nil

local iDmg = 0
local castDmg = 0

local toBlock = false

local isUnit = {
		['Malzahar']      = {spell = _E, spelln = "E"},
		['Mordekaiser']   = {spell = _R, spelln = "R"},
		['Tristana']      = {spell = _E, spelln = "E"},
		['Teemo']		  = {spell = _R, spelln = "R"},
		
	}

function OnLoad()
	PrintChat("<font color = \"#FFFFFF\">[Low Elo Flash Block] </font><font color = \"#FF0000\">Low Elo Flash Block by Fantastik version "..sversion.." loaded!</font> </font>")
	
	Config = scriptConfig("Block Fail Flash", "BFF")
		Config:addParam("Enabled", "Enable", SCRIPT_PARAM_ONOFF, true)
		
	if myHero:GetSpellData(SUMMONER_1).name:find("summonerflash") then
		flashslot = SUMMONER_1
	elseif myHero:GetSpellData(SUMMONER_2).name:find("summonerflash") then
		flashslot = SUMMONER_2
	end	
end

function OnTick()
	if myHero.dead then Igniter = nil toBlock = false Caster = nil end
	
	FREADY = (flashslot ~= nil and myHero:CanUseSpell(flashslot) == READY)
	
	if Igniter ~= nil then
		iDmg = getDmg("IGNITE", myHero, Igniter)
		if iDmg >= myHero.health then
			toBlock = true
		end
	end
end

function OnRemoveBuff(unit, buff)
	if unit.isMe and buff.name == "summonerdot" then
		HaveIgnite = false
		Igniter = nil
		toBlock = false
	end
end

function OnProcessSpell(unit, spell)
	if spell.name == "summonerdot" and spell.target.isMe then
		HaveIgnite = true
		Igniter = unit
	end
end

function OnDraw()
	if toBlock and FREADY and Config.Enabled then
		DrawText("Blocking Flash!", 30, 550, 200, 0xFFFFFF00)
	end
end

AddSendPacketCallback(function(p)	
	if p.header == 0x00E4 and Config.Enabled and toBlock then
		p.pos=6
		local slot = ({[0x23] = _Q, [0x54] = _W, [0xED] = _E, [0x82] = _R, [0xD0] = SUMMONER_1, [0x96] = SUMMONER_2,})[p:Decode1()]	
		
		if myHero:GetSpellData(SUMMONER_1).name:find("summonerflash") then
			flashslot = SUMMONER_1
		elseif myHero:GetSpellData(SUMMONER_2).name:find("summonerflash") then
			flashslot = SUMMONER_2
		end		
		
		if slot == flashslot then
			p.pos = 19
			local b = {}
			for i=8, 1, -1 do
				b[i] = startBytes[p:Decode1()]
			end
			local z = DwordToFloat(bxor(lshift(band(b[1],0xFF),24),lshift(band(b[2],0xFF),16),lshift(band(b[3],0xFF),8),band(b[4],0xFF)))
			local x = DwordToFloat(bxor(lshift(band(b[5],0xFF),24),lshift(band(b[6],0xFF),16),lshift(band(b[7],0xFF),8),band(b[8],0xFF)))
			p:Block()
			PrintChat("<font color = \"#FFFFFF\">[Low Elo Flash Block] </font><font color = \"#FF0000\">Blocking Low Elo Flash!</font> </font>")
		end
	end
end)
